{%- assign item = item | default: false -%}
{%- if encode == false -%}
  {%- assign encode = false -%}
{%- else -%}
  {%- assign encode = true -%}
{%- endif -%}
{%- capture tags -%}
{%- for tag in item.tags -%}
{%- if tag contains '-' -%}
{%- assign split_tags = tag | split: '-' -%}
,"{{split_tags[0]}}:{{split_tags | join: '-' | remove: split_tags[0] | remove_first: '-'}}"
{%- endif -%}
{%- endfor -%}
{%- endcapture -%}

{%- capture json -%}
{
  "id": {{ item.id | json }},
  "type": "{{ item.type }}",
  "resultType": "product",
  "images": [{%- for image in item.images -%}"{{ image.src | img_url: 'medium' }}"{%- unless forloop.last -%},{%- endunless -%}{%- endfor -%}],
  "media": {{- item.media | json -}},
  "variants": [{%- for variant in item.variants -%}
    {
      "title": {{ variant.title | json }},
      "id": {{ variant.id | json }},
      {%- if variant.image.src != blank -%}
      "image": {{ variant.image.src | img_url: 'master' | json }},
      {%- endif -%}
      "price": {{ variant.price | json }},
      "compareAtPrice": {{ variant.compare_at_price | json }},
      "option1": {{ variant.option1 | json }},
      "option2": {{ variant.option2 | json }},
      "option3": {{ variant.option3 | json }},
      "available": {{ variant.available | json }},
      "subscriptions": {{- variant.metafields.subscriptions | json -}}
    }
  {%- unless forloop.last -%},{%- endunless -%}{%- endfor -%}],
  "firstAvailableVariant": {{ item.first_available_variant | json }},
  "available": {%- if item.available -%}true{%- else -%}false{%- endif -%},
  "handle": {{ item.handle | json }},
  "title": {{ item.title | json }},
  "collections": {{ product.collections | map:'title' | json }},
  "vendor": {{ product.vendor | json }},
  "excerpt": {{ item.description | strip_html | truncatewords: 10, "..." | json }},
  "featuredImage": {{ item.featured_image | img_url: 'master' | json }},
  "tags": {{ item.tags | json }},
  "price": {{ item.price | json }},
  "compareAtPrice": {{ item.compare_at_price | json }},
  "compareAtPriceMax": {{ item.compare_at_price_max | json }},
  "optionsWithValues": {{item.options_with_values | json}},
  "hasOnlyDefaultVariant": {{ item.has_only_default_variant | json }},
  "optionNames": [{%- for option_name in item.options -%}{{ option_name | json }}{%- unless forloop.last -%},{%- endunless -%}{%- endfor -%}]{%- if item.options_with_values.size > 0-%},{%- endif -%}
  {%- for option in item.options_with_values -%}
  "{{option.name}}": [{%- for value in option.values -%}{{ value | json }}{%- unless forloop.last -%},{%- endunless -%}{%- endfor -%}]{%- unless forloop.last -%},{%- endunless -%}
  {%- endfor -%}
}
{%- endcapture -%}
{%- if encode -%}{{ json | url_encode }}{%- else -%}{{ json }}{%- endif -%}
